services:
  postgres:
    image: postgres:15
    container_name: evolution-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: evolution
      POSTGRES_USER: evolution
      POSTGRES_PASSWORD: evolution
    ports:
      - "5432:5432"
    volumes:
      - evolution_db:/var/lib/postgresql/data
    networks:
      - evolution-network

  evolution-api:
    image: atendai/evolution-api:latest
    container_name: evolution-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    environment:
      # Configuração do servidor
      SERVER_URL: http://localhost:8080
      PORT: 8080
      
      # --- CORREÇÃO 1: Variável essencial para rodar no Docker ---
      DOCKER_ENV: 'true'
      
      # API Key
      AUTHENTICATION_API_KEY: ${EVOLUTION_API_KEY:-sua-chave-secreta}
      
      # --- CORREÇÃO 2: Endereço correto para o Webhook (host.docker.internal) ---
      # Isso permite que o container "veja" o seu Next.js rodando no Windows/Mac
      WEBHOOK_URL: http://192.168.0.91:3001/api/webhook
      WEBHOOK_EVENTS: messages.upsert,connection.update,qrcode.update
      
      # Configurações do WhatsApp
      QRCODE_LIMIT: 30
      QRCODE_COLOR: '#198754'
      
      # Logs
      LOG_LEVEL: ERROR
      LOG_COLOR: true
      LOG_BAILEYS: error
      
      # Configurações de instância
      CONFIG_SESSION_PHONE_CLIENT: Chrome
      CONFIG_SESSION_PHONE_NAME: Chrome
      
      # Redis (desabilitado)
      REDIS_ENABLED: 'false'
      
      # Database
      DATABASE_ENABLED: 'true'
      DATABASE_PROVIDER: postgresql
      DATABASE_CONNECTION_URI: postgresql://evolution:evolution@postgres:5432/evolution
      
      # Fixes para geração de QR Code
      NODE_OPTIONS: --dns-result-order=ipv4first
      
      # Versão do WhatsApp Web
      CONFIG_SESSION_PHONE_VERSION: 2.3000.1015901307
      
    # DNS do Google
    dns:
      - 8.8.8.8
      - 8.8.4.4
      
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
      
    networks:
      - evolution-network
    
    # --- ADICIONAL: Isso ajuda o host.docker.internal a funcionar no Linux, se necessário ---
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  evolution_instances:
  evolution_store:
  evolution_db:

networks:
  evolution-network:
    driver: bridge